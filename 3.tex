\chapter{ブロックチェーン技術}
本章では、本研究で用いるブロックチェーン技術について述べる。
最初に仕組みや説明を述べ、その技術が持つ問題点や現状の政治的な問題点について述べる。
その後、ブロックチェーン技術を最大限に活用するための技術であるオフチェーン技術について述べる。
そして、ブロックチェーン技術を用いた暗号通貨の代表的なものについて説明を行う。
最後に、本章のまとめを行う。

\section{仕組み}
本節では、ブロックチェーンの仕組みについて述べる。
また詳しくは後の\ref{3.1.4}項にて後述するが、ブロックチェーンにはいくつかの種類が存在する。
ここでは特に指定のない限り、中央集権的な機関の存在しない、パブリック型ブロックチェーンについての説明を行う。

\subsection{P2P通信}
ブロックチェーンはP2P通信によって行われる。
このP2P通信とは、対等の端末間で行われる通信のことである。
通常のネットワークサービスは、クライアント・サーバ型と呼ばれる通信機能によって運営されている。
サーバ側ではサービス運営者がサービスや機能を提供するアクセス可能なコンピュータであるサーバを設置し、このサーバ上でサービスが運営される。
例えば慶應義塾大学湘南藤沢キャンパスにて使われている学事システムのSFC-SFSでは、履修可能単位の閲覧機能、履修単位申告機能、履修者が過剰になった時の選抜機能などを提供している。
この機能を運営しているコンピュータを一般に、サーバと呼ぶ。
これに対し、利用者はクライアント側となる。
クライアントとは、サーバに対してそれが持つ機能を使わせてもらうためのリクエストを送るコンピュータのことである、
SFC-SFSの例では、学生がサービスにアクセスするために使うスマートフォンやPCなどがこれに当たる。
つまり、サービスの提供者側であるサーバと消費者側であるクライアントで役割が分かれていることが特徴だ。
このような形で通常のネットワークサービスは運営されるが、P2Pサービスはこれと異なる。
P2Pサービスでは、通信する端末間の関係が対等である。
つまり通信する双方が同じ機能を持ち、相手へサービスを提供する一方で、相手からサービスを受けているという状況が発生しているのだ。
P2Pサービスの例として、インターネット回線を使った通話アプリが存在する。
P2Pの通話サービスの場合、Aの端末とBの端末で通話を行なっている時、この通話アプリを提供している会社は二人の会話中の通信について関与していない。
双方ともが自分の音声を相手へ提供する機能と相手の音声を受け取る機能を持つ、つまりクライアント・サーバ型の両方の機能を双方が持っているのだ。
以上がP2P通信の特徴である。
ブロックチェーン技術は中央集権を持たない環境での分散台帳技術であるが、これにはP2P通信が使われている。
したがって、全ての参加者がサービスの使用者としての役割のみならず、サービスの提供者としての役割も持っているのだ。

\subsection{デジタル署名とアドレス}
デジタル署名とは、あるメッセージが署名した人によって作られたかを検証する仕組みである。
ここでは「Aが自分の3BTC(Bitcoin)を使いたい」と主張する時に、それが本当にAの発言であるかを担保するのがこのデジタル署名の役割である。
代表的なブロックチェーンであるBitcoinやEthereumではECDSA(楕円曲線DSA, Elliptic Curve Digital Signature Algorithm)を利用しており、これについて説明を述べる。
(!!!後に参照する図を挿入のこと！)
\begin{equation}
y^2 = x^3 + ax + b
\end{equation}
以上が楕円曲線について一般的に表される式である。
この中でもBitcoinやEthereumが用いる規格であるsecp256k1曲線はa=0, b=7であるため、以上の方程式は
\begin{equation}
y^2 = x^3 + 7
\end{equation}
上記のように表される。
また楕円曲線の加算の定義として、点Aと点Bを加算することを考える。
この時、加算後の座標は点Aと点Bとを通る直線のもう一つの交点のx軸に関して対称移動させた点である。
したがって点Aと点Bが同一座標の点Gであるとき、その接線と楕円曲線との交点をx軸に関して対称移動させた点は
G + G = 2G
となる。
secp256k1はGのベースポイントを定めており、そこから秘密鍵rを掛け合わせたrGが公開鍵となる。
この時、楕円曲線上の離散対数問題によって秘密鍵から公開鍵を導出することは容易であるが、逆の公開鍵から秘密鍵を導出することは難しいことが知られている。
この秘密鍵を使い、「自分のBitcoinを使いたい」と主張することによって、利用者は自分のBitcoinを使用する事が可能となる。
この主張を行う際の署名値は以下の式によって導かれる。
\begin{equation}
S=\frac{h+kR}{q}{(mod p)}
\end{equation}
\begin{list}{}{}
\item q：一回のみ使われる乱数(\(1 \leq q \leq 2^256-2^32-977\))
\item h：取引情報のハッシュ値
\item k：送信者の秘密鍵
\item R:一時的な公開鍵のx座標
\item p:楕円曲線のx座標がこれより大きくならないための値で素数
\end{list}

そしてこれらの値のうち、SとRが署名となり、ブロックチェーン上で周知される。
この主張が本人のみ知り得る秘密鍵を使って行われたものかを確認する際は、以下の式を使って検証する。
\begin{equation}
Q=\frac{hG}{S}+\frac{RK}{S}{(mod p)}
\end{equation}

\begin{list}{}{}
\item S, Q, R：送信者から受け取った署名
\item h：取引情報のハッシュ値
\item G：secp256k1のベースポイント
\item K：送信者の公開鍵
\item p:楕円曲線のx座標がこれより大きくならないための値で素数
\end{list}

以上の式において、Qのx座標が送信者が送信したRの座標と一致する時、この署名は正しいものであると検証される。
また、この公開鍵をBitcoinやEthereumではKeccak256ベースのハッシュ関数によってハッシュ化し、そのハッシュ値の末尾20バイトを抜き出したものがアドレスとして使われる。
そして「そのアドレスに対して、3BTCを送金する」と主張できるようになり、このアドレスの管理者(つまり元の公開鍵や秘密鍵を持っている者)がその後、「ここで受け取った3BTCを使う」と主張できるようになるのだ。
(!!!後に参照する図を挿入のこと！)

\subsection{ブロックチェーン技術}
ブロックチェーン技術の詳細については後の3章にて述べるが、ここではこの技術の背景と概要について述べる。
詳細な理由については後述するが、IoTデータ市場は管理主体が存在しないほうが望ましい。
そして管理主体のいない市場を作る際は、その市場の金の流れについて全員が合意に達する必要がある。
この合意に達するためのアルゴリズムがブロックチェーン技術である。
合意アルゴリズムに関する研究は、現在最も有名なBitcoin\cite{Bitcoin}の開発以前も行われてきた。
完全に管理主体の存在しない研究として挙げられる'b-money'\cite{b-money}では、参加者の全員が受け取れる単一の歴史を示す元帳が必要であるとした。
これは現在のBitcoinをはじめとするブロックチェーンのアイデアの中心となるものである。
さらに、計算問題によって金を創造するという現在のブロックチェーンに使われているアイデアもこの論文にて導入されたが、提案が不十分であったため実装がなされなかった。
これらのアイデアをProof Of Workという具体的な手法で具現化し実装可能となり、作られたのがBitcoinであり、ここで使われている技術や後に更に考案された技術が総称されてブロックチェーン技術と呼ばれている。
現在ではチューリング完全で様々な暗号通貨の基軸暗号通貨プラットフォームとして使われているEthereum\cite{ethereum}やギャンブルのチップとして使われるAugur\cite{Augur}, 半中央集権的なRipple\cite{Ripple}などもこのブロックチェーン技術によって存在している。

\subsection{トランザクション}
ここでは、Bitcoinを例にとトランザクションについて説明を行う。
ブロックチェーン上の記録は、全てトランザクションという単位毎に格納される。
つまり、「AがBに3BTCを渡した」という記録が一つのトランザクションに格納されるということだ。
このトランザクションはインプット部分とアウトプット部分、そしてその他の部分が存在する。
インプットには、当該トランザクションのトークンの出所が存在している。
例えば、「Aが3BTCを使う」と申し出たとしよう。
この時、ネットワーク全体が「Aは３BTC以上持っている」ということが分からないと、Aが3BTC使うという行為は認められない。
ここで「3BTC以上持っている」ということは、換言すると「3BTC以上を誰かから送金された過去があり、そのBTCは未だに使用されていない」ということである。
この「未だに使用されていなく、その所有者が未だ使える状態」のトランザクションのことをBitcoinではUTXO(Unspent Transaction Output)と呼ぶ。
このUTXOを使おうとする時は、トランザクションのインプットにUTXOの存在する場所を明示することで、UTXOを使う事ができる。
つまり、インプットはトランザクションの送金における払い手に当たる情報が入る部分と言える。
次に、アウトプットについて説明する。
アウトプットはトランザクションの送金における受け取り手に当たる情報が入る部分である。
前項で述べたように、受け取り手の情報はアドレスによって表される。
したがって、「AがBに3BTCを渡した」あとで未だにBがこれを使っていない状態の時、このトランザクションのアウトプットの署名欄にはBitcoinアドレスが存在している。
その後、「BがCに3BTCを渡した」とすると、先ほどBitcoinアドレスが書かれていた署名欄にはBitcoinアドレスの素となった公開鍵とこの公開鍵に対応する署名値が代入される。
つまり、あるアウトプットがUTXOであるか否かの判断はこの署名欄にBitcoinアドレスがあるか公開鍵と署名値が存在するかの違いによって行われる。
このようにしてトランザクションは管理される。

\subsection{ブロックとマイニング}
ここではブロックとマイニングについて説明を行う。
ブロックチェーン技術は情報の記録を単一の歴史を共有することによって、参加者の合意できる台帳管理を行おうとする技術である。
この単一の歴史を刻む歴史書の1ページが1ブロックに当たる。
現在のBitcoinでは10分に1回、Ethereumでは15秒に1回、それぞれのペースで新しいブロックが生成される。
このブロックにはトランザクションが0個以上含まれており、その処理内容が単一の歴史として刻まれる。
そしてブロックチェーン技術はこの方式によって、二重支払い問題を解決している。
Aが3BTCを持っている時、同時に「AがBに3BTCを払う」と「AがCに3BTC払う」というトランザクションを発行しようとしたとする。
しかし、ブロックが生成される際にのみ送金の処理は行われるため、ネットワークの遅延等の影響によって二つのトランザクションが承認されることはあり得ない。
また、各々のブロックはヘッダに前のブロック情報をまとめたハッシュ値を持っており、どのブロックの次に繋げられたブロックであるかを明示している。
このブロックがチェーンのように何個も連なることによって、ブロックチェーンという分散管理台帳が形成されていく。
そしてこのブロックが生成される際に行われることが、マイニングと呼ばれる行為である。そしてブロックの生成を行おうとする者をマイナーと呼ぶ。
ブロック情報をまとめたハッシュ値の中には、ナンスと呼ばれるブロックのマイナーが付加する32bitの数値が存在する。
このナンスを含めたハッシュ値が、一定の数だけ頭に0を持つようにすることによって、そのブロックは正当なブロックであると承認されるようになっている。
例えば、ビットコインのメインネットワークにおいて553582番目に生成されたブロックの情報について見てみる。
以下はBitcoinの現在の統計情報などを提供しているhttps://www.blockchain.com/ja/ から取得した情報である。
すると、ハッシュ値は「0000000000000000001b0218ca2b54e9809b5d948864c5bd1e657e5aa09f438f」となっている。
そしてこの時のナンスの値は「4142738813」となっている。
ブロックの持つトランザクションのハッシュ値などの情報に、このナンス値を足したところ、このように頭にいくつもの0がつくハッシュ値を見つけ出せたのである。
この時この様々なナンスの値を取り付け、0が頭に一定数以上つくハッシュ値を見つけ出す行為について、マイニングと呼ぶ。
そしてこのマイニングという行為によって、ブロックチェーンにおける改竄可能性を防いでいるのだ。
現在(2018-12-13 00:46:30)、マイニングは16進数において頭の18文字に0が続く場合、ブロックが生成されるようになっている。
つまり、最新より一つ前のブロックのハッシュ値をブロックに含めて\(16^18\)回の演算を行うことで最新のブロックを無効にでき、自分の思い通りのブロックを提出する事ができる。
しかし、2つ前のブロックを変更しようとするときはどうだろう。
Bitcoinの各参加者は、ブロックがもっとも長く連なったブロックチェーンを信用するように設計されている。
つまり2つ前を変更するには、新しく2つ分のブロックを生成しなくてはならないのだ。
この時に必要な計算量は\(16^(18\times2) \)となり、難易度は格段に上昇する。
これがさらに3つ前、4つ前..となっていくと、事実上変更は不可能となる。
よって3BTCを払い、その対価としてのサービスを受けたのちにその支払ったBTCを取り返すために新しいブロックを作り直す行為は、ブロックが一定数以上深くなった場合においては不可能である。
つまり理論的にブロックの改竄は可能であるが、それは実際にはそれを行うことは極めて難しいということである。
これがブロックチェーンの参加者が公開台帳を信用する理由であり、改竄耐性を持つという理由である。
このようにしてブロックは生成され、ブロックチェーンは管理される。

\section{問題点}
ここでは、前半の2項で技術面から見たブロックチェーン技術の問題点を述べる。
その後、後半の2項で政治面から見た問題点を述べる。
